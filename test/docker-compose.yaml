services:
  passenger_with_app:
    build:
      context: ../
      dockerfile: test/dockerfiles/Dockerfile.with-app
    hostname: 'passenger_with_app'
    ports:
      - "10254"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10254/monitus/metrics"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 45s
    networks:
      - test_network
      
  passenger_without_app:
    build:
      context: ../
      dockerfile: test/dockerfiles/Dockerfile.without-app
    hostname: 'passenger_without_app'
    ports:
      - "10254"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10254/monitus/metrics"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 45s
    networks:
      - test_network
      
  passenger_with_visible_prometheus:
    build:
      context: ../
      dockerfile: test/dockerfiles/Dockerfile.with-visible-prometheus-app
    hostname: 'passenger_with_visible_prometheus'
    ports:
      - "10254"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10254/monitus/metrics"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 45s
    networks:
      - test_network
      
  test:
    image: "phusion/passenger-ruby32:2.5.1"
    command: ["/src/test/run_all_tests.sh"]
    depends_on:
      passenger_with_app:
        condition: service_healthy
      passenger_without_app:
        condition: service_healthy
      passenger_with_visible_prometheus:
        condition: service_healthy
    volumes:
      - ../:/src
    networks:
      - test_network
    working_dir: /src
    
networks:
  test_network:
    driver: bridge
